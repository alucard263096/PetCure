<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>{{$Title}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />    
    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" media="screen" href="{{$rootpath}}/css/style.css">
</head>
<body>
    <!--   定义地图显示容器   -->
    <div id="container"></div>
    <button class="btn btn-default" id="btnPost">发起救助</button>
    <div id="ctxPoster" >        
    </div>
    <iframe id="geoPage" width=0 height=0 frameborder=0 style="display:none;" scrolling="no" src="http://apis.map.qq.com/tools/geolocation?key=EBWBZ-CZN3K-4O5JK-A3WQF-5HOCS-HUB2O&referer={{$Title}}"></iframe>

    <script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp&key={{$MapKey}}"></script>
    <script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script>
        var map;
        var loc;
        $(document).ready(function () {
            initCtxPoster();
            initMap();
            locateUser();
        });
        function initMap() {
            map = new qq.maps.Map(document.getElementById("container"), {
                center: new qq.maps.LatLng(22.543670, 114.059640),      // 地图的中心地理坐标。
                zoom: 14                                               // 地图的中心地理坐标。
            });
        }
        function locateUser() {
            window.addEventListener('message', function (event) {
                // 接收位置信息
                loc = event.data;
                markLocation();
            }, false);
        }
        function initCtxPoster() {
            $("#ctxPoster").hide();
            $("#btnPost").click(function () {
                $("#ctxPoster").load("{{$rootpath}}/poster.php", function () {
                    $("#ctxPoster").fadeIn();
                });
            });
        }
        function markLocation() {
            if (loc && loc.module == 'geolocation') { //定位成功,防止其他应用也会向该页面post信息，需判断module是否为'geolocation'
                var center = new qq.maps.LatLng(loc.lat, loc.lng);

                map.setCenter(center);
                var marker = new qq.maps.Marker({
                    //设置Marker的位置坐标
                    position: center,
                    //设置显示Marker的地图
                    map: map
                });
                marker.setTitle("我的位置");
                if ($("#ctxPoster #txtAddress").length > 0) {
                    $("#ctxPoster #txtAddress").val(loc.addr);
                }
            } else { //定位组件在定位失败后，也会触发message, event.data为null
                alert('定位失败');
            }
        }
        
    </script>
</body>


</html>